function doPost(e) {
  const sheetMap = {
    "Stocktake": "StockTag",
    "OOS": "OOS",
    "IDT": "IDT"
  };

  const data = JSON.parse(e.postData.contents);
  const mode = data.mode;
  const sheetName = sheetMap[mode];

  if (!sheetName) return ContentService.createTextOutput("Invalid mode");

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  const now = new Date();

  if (mode === "Stocktake") {
    sheet.appendRow([
      now,
      data.name || "",
      data.department || "",
      data.stockDate || "",
      data.barcode || "",
      data.quantity || "",
      data.comment || ""
    ]);
  } else if (mode === "OOS") {
    sheet.appendRow([
      now,
      data.name || "",
      data.barcode || "",
      data.comment || ""
    ]);
  } else if (mode === "IDT") {
    sheet.appendRow([
      now,
      data.name || "",
      data.barcode || "",
      data.fromDept || "",
      data.toDept || "",
      data.quantity || "",
      data.comment || ""
    ]);
  }

  return ContentService.createTextOutput("Success");
}

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu("Scanner Tools")
    .addItem("Clear Stocktake Data", "clearStocktakeData")
    .addToUi();
}

function clearStocktakeData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("StockTag");
  const lastRow = sheet.getLastRow();

  if (lastRow <= 1) {
    SpreadsheetApp.getUi().alert("Nothing to clear.");
    return;
  }

  const folder = DriveApp.getFolderById("1ASC0HsIq864DWX9_-cy5uVkMW7okzapy");
  const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
  const backupName = `Backup_Stocktake_${timestamp}`;
  const backup = ss.copy(backupName);

  folder.addFile(DriveApp.getFileById(backup.getId()));
  DriveApp.getRootFolder().removeFile(DriveApp.getFileById(backup.getId()));

  sheet.getRange("A2:G" + lastRow).clearContent();
  SpreadsheetApp.getUi().alert("âœ… Stocktake log backed up and cleared. Ready for next scan.");
}
