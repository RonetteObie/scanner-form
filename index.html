<!DOCTYPE html>
<html>
<head>
  <title>BURFAM Scanner App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <style>
    :root { --pad:20px; --radius:12px; }
    * { box-sizing: border-box; }
    html, body { margin:0; height:100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: var(--pad);
      display:flex; align-items:center; justify-content:center;
      overscroll-behavior-y: contain; background:#f9fafb;
    }
    .card {
      width: min(420px, 92vw);
      background:#fff; border-radius: var(--radius);
      box-shadow: 0 6px 24px rgba(0,0,0,.08);
      padding: var(--pad);
    }
    h2 { margin: 0 0 12px; font-weight: 700; }
    label { display:block; margin: 14px 0 6px; font-weight:600; }
    input, select, button {
      width:100%; font-size:16px; padding:12px 14px;
      border:1px solid #d1d5db; border-radius:10px; outline:none;
    }
    input:focus, select:focus { border-color:#4CAF50; box-shadow:0 0 0 3px rgba(76,175,80,.15); }
    input.upper { text-transform: uppercase; }
    button { margin-top:14px; border:none; color:#fff; background:#22c55e; border-radius:12px; font-weight:700; }
    .btn-secondary { background:#6b7280; }
    .row { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .hint { font-size:.92rem; color:#374151; background:#f3f4f6; padding:10px; border-radius:10px; }
    .muted { color:#6b7280; font-size:.9rem; }
    .hidden { display:none !important; }
    .static-field {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border:1px dashed #d1d5db; border-radius:10px;
      background:#fafafa; margin-top:8px;
    }
    .pill { font-size:.8rem; padding:4px 10px; border-radius:999px; background:#e5f7eb; color:#15803d; font-weight:700; }

    /* Toast */
    .toast {
      position: fixed; left:50%; bottom:18px; transform: translateX(-50%) translateY(20px);
      background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
      font-size:14px; opacity:0; pointer-events:none; transition: all .25s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,.2);
    }
    .toast.show { opacity:1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <div class="card">
    <h2>BURFAM Scanner App</h2>

    <!-- Setup -->
    <div id="panel-setup">
      <div class="hint">
        Use format: <b>NAME + STORE CODE</b><br>
        Example: <b>RONETTE SBK</b><br><br>
        Store Codes:<br>
        <b>SBK</b> = Springbok<br>
        <b>PN</b> = Port Nolloth<br>
        <b>VRD</b> = Vredendal
      </div>

      <label for="name">Your Name + Store Code</label>
      <input class="upper" type="text" id="name" placeholder="e.g. RONETTE SBK"
             autocomplete="off" autocapitalize="characters" required>

      <label for="mode">Scan Mode</label>
      <select id="mode" required>
        <option value="">Select Mode</option>
        <option value="Stocktake">Stocktake</option>
        <option value="OOS">Out of Stock</option>
        <option value="IDT">Inter Department Transfer (IDT)</option>
      </select>

      <div id="stocktakeFields" class="hidden">
        <label for="stockDate">Date of Stocktake</label>
        <input type="date" id="stockDate">
        <label for="department">Department</label>
        <select id="department"></select>
      </div>

      <div id="idtFields" class="hidden">
        <div class="row">
          <div>
            <label for="fromDept">From Department</label>
            <select id="fromDept"></select>
          </div>
          <div>
            <label for="toDept">To Department</label>
            <select id="toDept"></select>
          </div>
        </div>
      </div>

      <button id="btn-submit-initial">Submit</button>
      <button type="button" class="btn-secondary" id="btn-reset">Reset</button>
      <p class="muted" style="margin-top:10px;">Please check your "Name{Space}Store"; on next page only barcode field is editable. Tap barcode Field to activate scan or Manual entry</p>
    </div>

    <!-- Scan -->
    <div id="panel-scan" class="hidden">
      <div class="static-field">
        <div>
          <div id="summary-name" style="font-weight:700;"></div>
          <div id="summary-mode" class="muted"></div>
        </div>
        <div class="pill" id="summary-store"></div>
      </div>

      <div id="stocktakeExtra" class="hidden">
        <label for="quantity">Quantity (Stocktake)</label>
        <input type="number" id="quantity" min="0" step="any" inputmode="decimal">
      </div>

      <div id="idtExtra" class="hidden">
        <label for="idtQuantity">Quantity (IDT)</label>
        <input type="number" id="idtQuantity" min="0" step="any" inputmode="decimal">
      </div>

      <label for="barcode" style="margin-top:16px;">Barcode</label>
      <input
        type="text" id="barcode"
        inputmode="numeric" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
        placeholder="TAP to Scan or type digits" required maxlength="32" pattern="[0-9]*"
      >

      <button id="btn-submit-scan">Submit</button>
      <button type="button" class="btn-secondary" id="btn-reset-2">Reset</button>

      <!-- locked identity -->
      <input type="hidden" id="nameHidden">
      <input type="hidden" id="storeHidden">
      <input type="hidden" id="modeHidden">
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">Barcode submitted</div>

  <script>
    // ===== Kill any blocking popups (incl. “duplicate scan” prompts) =====
    window.alert = function () {};
    window.confirm = function () { return true; };
    window.prompt = function () { return null; };
    window.onbeforeunload = null;

    // ===== Config =====
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzJLQD6WScnGAd8PlYtfcdhH6Km7Kt31E2b4d0md0kLRw8cryX0GbSil_1zwWlSpIS9hQ/exec";
    const departments = [
      "BAKERY CONFEC","BUTCHERY","DELICATESSEN","FRUIT & VEG","FAST FOODS",
      "BEAN TREE","BULK CHEESE","SUSHI","WHY NOT","CHIKKA CHICKEN","BAKERY BREAD",
      "BAKERY CONFEC_INGREDIENTS","BUTCHERY_INGREDIENTS","DELICATESSEN_INGREDIENTS",
      "FRUIT & VEG_INGREDIENTS","FAST FOODS_INGREDIENTS","BEAN TREE_INGREDIENTS",
      "BULK CHEESE_INGREDIENTS","SUSHI_INGREDIENTS","WHY NOT_INGREDIENTS",
      "CHIKKA CHICKEN_INGREDIENTS","BAKERY BREAD_INGREDIENTS"
    ];

    // ===== Elements =====
    const panelSetup   = document.getElementById("panel-setup");
    const panelScan    = document.getElementById("panel-scan");
    const nameEl       = document.getElementById("name");
    const modeEl       = document.getElementById("mode");
    const stocktakeFields = document.getElementById("stocktakeFields");
    const idtFields       = document.getElementById("idtFields");
    const stocktakeExtra  = document.getElementById("stocktakeExtra");
    const idtExtra        = document.getElementById("idtExtra");
    const barcodeEl    = document.getElementById("barcode");
    const quantityEl   = document.getElementById("quantity");
    const idtQuantityEl= document.getElementById("idtQuantity");
    const deptEl       = document.getElementById("department");
    const fromDeptEl   = document.getElementById("fromDept");
    const toDeptEl     = document.getElementById("toDept");
    const summaryName  = document.getElementById("summary-name");
    const summaryMode  = document.getElementById("summary-mode");
    const summaryStore = document.getElementById("summary-store");
    const nameHidden   = document.getElementById("nameHidden");
    const storeHidden  = document.getElementById("storeHidden");
    const modeHidden   = document.getElementById("modeHidden");
    const toastEl      = document.getElementById("toast");

    // ===== Toast helper =====
    let toastTimer = null;
    function showToast(msg = "Barcode submitted") {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1200);
    }

    // ===== Helpers =====
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function toUpperLive(el){
      el.addEventListener("input", () => {
        const s = el.selectionStart, e = el.selectionEnd;
        el.value = el.value.toUpperCase();
        if (s != null && e != null) el.setSelectionRange(s, e);
      });
    }
    function fillDropdown(sel){
      sel.innerHTML = '<option value="">Select</option>';
      departments.forEach(d => {
        const o = document.createElement("option");
        o.value = d; o.textContent = d; sel.appendChild(o);
      });
    }
    function deriveStoreCode(nameVal){
      const token = (nameVal || "").trim().toUpperCase().split(/\s+/).pop();
      if (["SBK","PN","VRD"].includes(token)) return token;
      return "";
    }
    function focusBarcodeSoon(){ setTimeout(()=>barcodeEl.focus(), 40); }
    function saveSession(){
      const payload = {
        locked: !panelScan.classList.contains("hidden"),
        name: nameHidden.value || nameEl.value || "",
        store: storeHidden.value || "",
        mode: modeHidden.value || modeEl.value || "",
        department: deptEl.value || "",
        fromDept: fromDeptEl.value || "",
        toDept: toDeptEl.value || "",
        stockDate: (document.getElementById("stockDate")?.value) || ""
      };
      sessionStorage.setItem("burfamSession", JSON.stringify(payload));
    }
    function restoreSession(){
      try{
        const raw = sessionStorage.getItem("burfamSession");
        if (!raw) return;
        const s = JSON.parse(raw);

        if (s.locked) {
          nameHidden.value = s.name;
          storeHidden.value = s.store || deriveStoreCode(s.name);
          modeHidden.value  = s.mode;
          summaryName.textContent  = s.name;
          summaryMode.textContent  = s.mode;
          summaryStore.textContent = storeHidden.value || "—";
          hide(panelSetup); show(panelScan);
          if (s.mode === "Stocktake") { show(stocktakeExtra); hide(idtExtra); }
          else if (s.mode === "IDT")  { hide(stocktakeExtra); show(idtExtra); }
          else { hide(stocktakeExtra); hide(idtExtra); }
          focusBarcodeSoon();
        } else {
          if (s.name) nameEl.value = s.name.toUpperCase();
          if (s.mode) modeEl.value = s.mode;
          const stockDateEl = document.getElementById("stockDate");
          if (stockDateEl && s.stockDate) stockDateEl.value = s.stockDate;
          adjustFormFields();
        }
      } catch(e) { /* ignore */ }
    }
    function adjustFormFields(){
      const mode = modeEl.value;
      if (mode === "Stocktake") { show(stocktakeFields); hide(idtFields); }
      else if (mode === "IDT")  { hide(stocktakeFields); show(idtFields); }
      else { hide(stocktakeFields); hide(idtFields); }
      saveSession();
    }
    function lockIdentityIfPossible(){
      const rawName = (nameEl.value || "").trim().toUpperCase();
      const mode    = modeEl.value;
      const store   = deriveStoreCode(rawName);
      if (!rawName || !mode || !store){ return false; }
      nameEl.value = rawName;
      nameHidden.value  = rawName;
      storeHidden.value = store;
      modeHidden.value  = mode;
      summaryName.textContent  = rawName;
      summaryMode.textContent  = mode;
      summaryStore.textContent = store;
      hide(panelSetup); show(panelScan);
      if (mode === "Stocktake") { show(stocktakeExtra); hide(idtExtra); }
      else if (mode === "IDT")  { hide(stocktakeExtra); show(idtExtra); }
      else { hide(stocktakeExtra); hide(idtExtra); }
      saveSession();
      barcodeEl.value = "";
      focusBarcodeSoon();
      return true;
    }

    // ===== TEMP: lock to OOS only (place AFTER adjustFormFields & DOM refs) =====
    const TEMP_LOCK_TO_OOS = true; // set to false later to re-enable other modes
    if (TEMP_LOCK_TO_OOS) {
      const stockOpt = document.querySelector('#mode option[value="Stocktake"]');
      const idtOpt   = document.querySelector('#mode option[value="IDT"]');
      if (stockOpt) { stockOpt.disabled = true; stockOpt.textContent += ' — disabled'; }
      if (idtOpt)   { idtOpt.disabled   = true; idtOpt.textContent   += ' — disabled'; }
      modeEl.value = 'OOS';
      modeEl.disabled = true;   // comment this line to show dropdown but fixed
      adjustFormFields();
    }

    // ===== Event wiring =====
    toUpperLive(nameEl);
    fillDropdown(deptEl); fillDropdown(fromDeptEl); fillDropdown(toDeptEl);
    modeEl.addEventListener("change", adjustFormFields);
    nameEl.addEventListener("blur", () => { nameEl.value = (nameEl.value||"").toUpperCase(); saveSession(); });

    document.getElementById("btn-submit-initial").addEventListener("click", (e)=>{
      e.preventDefault();
      lockIdentityIfPossible();
    });

    document.getElementById("btn-submit-scan").addEventListener("click", (e)=>{
      e.preventDefault();
      if (panelScan.classList.contains("hidden")) return;
      const barcode = (barcodeEl.value || "").trim();
      if (!barcode){ focusBarcodeSoon(); return; }

      const payload = {
        mode:  modeHidden.value,
        timestamp: new Date().toISOString(),
        name:  nameHidden.value,
        store: storeHidden.value,
        barcode
      };
      if (modeHidden.value === "Stocktake") {
        payload.department = deptEl.value;
        payload.stockDate  = document.getElementById("stockDate").value;
        payload.quantity   = quantityEl.value;
      } else if (modeHidden.value === "IDT") {
        payload.fromDept = fromDeptEl.value;
        payload.toDept   = toDeptEl.value;
        payload.quantity = idtQuantityEl.value;
      }

      // Fire-and-forget; immediately show success toast
      fetch(ENDPOINT, { method:"POST", mode:"no-cors", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });

      showToast("Barcode submitted");
      barcodeEl.value = "";
      if (quantityEl) quantityEl.value = "";
      if (idtQuantityEl) idtQuantityEl.value = "";
      focusBarcodeSoon();
    });

    function hardReset(){
      sessionStorage.removeItem("burfamSession");
      nameEl.value = ""; modeEl.value = "";
      if (deptEl) deptEl.value = "";
      if (fromDeptEl) fromDeptEl.value = "";
      if (toDeptEl) toDeptEl.value = "";
      const sd = document.getElementById("stockDate"); if (sd) sd.value = "";
      barcodeEl.value = ""; if (quantityEl) quantityEl.value=""; if (idtQuantityEl) idtQuantityEl.value="";
      show(panelSetup); hide(panelScan);
      hide(stocktakeFields); hide(idtFields);
      hide(stocktakeExtra); hide(idtExtra);
      nameHidden.value = ""; storeHidden.value=""; modeHidden.value="";
      setTimeout(()=>nameEl.focus(), 50);
    }
    document.getElementById("btn-reset").addEventListener("click", hardReset);
    document.getElementById("btn-reset-2").addEventListener("click", hardReset);

    ["department","fromDept","toDept","stockDate"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener("change", saveSession);
    });

    // Restore state on load (so pull-to-refresh keeps you on scan panel)
    restoreSession();

    // Keep focus welded to barcode
    barcodeEl.addEventListener("blur", () => { if (!panelScan.classList.contains("hidden")) setTimeout(()=>barcodeEl.focus(), 30); });
    window.addEventListener("pageshow", ()=>{ if (!panelScan.classList.contains("hidden")) focusBarcodeSoon(); });
    document.addEventListener("visibilitychange", ()=>{ if (document.visibilityState==="visible" && !panelScan.classList.contains("hidden")) focusBarcodeSoon(); });
    panelScan.addEventListener("pointerdown", ()=>{ if (!panelScan.classList.contains("hidden")) focusBarcodeSoon(); });

    // ===== Scanner key buffer (does NOT interfere with manual typing) =====
    let scanBuf = "";
    let scanTimer = null;
    const COMMIT_MS = 120;

    function commitScanBuffer() {
      if (!scanBuf) return;
      const cleaned = scanBuf.replace(/\D+/g,"");
      if (cleaned) {
        barcodeEl.value = cleaned;
        focusBarcodeSoon();
      }
      scanBuf = "";
      if (scanTimer) { clearTimeout(scanTimer); scanTimer = null; }
    }

    document.addEventListener("keydown", (e)=>{
      if (panelScan.classList.contains("hidden")) return;
      // If user is actively typing in the barcode field, DO NOT intercept.
      if (document.activeElement === barcodeEl) return;

      // Capture scanner digits only when focus isn't already in barcode
      if (/^[0-9]$/.test(e.key)) {
        scanBuf += e.key;
        if (scanTimer) clearTimeout(scanTimer);
        scanTimer = setTimeout(commitScanBuffer, COMMIT_MS);
        e.preventDefault();
      } else if (e.key === "Enter") {
        commitScanBuffer();
        e.preventDefault();
      }
    });

    document.addEventListener("paste", (e)=>{
      if (panelScan.classList.contains("hidden")) return;
      if (document.activeElement === barcodeEl) return; // let normal pastes happen
      const text = (e.clipboardData && e.clipboardData.getData('text')) || "";
      if (text) {
        barcodeEl.value = text.replace(/\s+/g,"");
        focusBarcodeSoon();
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
