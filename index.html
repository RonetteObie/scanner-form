<!DOCTYPE html>
<html>
<head>
  <title>BURFAM Scanner App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    body {
      font-family: sans-serif;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100vw;
      overflow-x: hidden;
    }
    form { width: 90vw; max-width: 400px; }
    label { display: block; margin-top: 15px; }
    input, select, button, textarea {
      width: 100%; padding: 10px; margin-top: 5px; font-size: 1rem; box-sizing: border-box;
    }
    button { margin-top: 20px; background-color: #4CAF50; color: white; border: none; }
    .btn-secondary { background-color: #888; margin-top: 10px; }
  </style>
</head>
<body>
  <form id="scannerForm" autocomplete="off">
    <h2>BURFAM Scanner App</h2>

    <small style="display:block; margin-top:5px; font-size:0.9rem; color:#333;">
      Use format: <b>Name + Store Code</b><br>
      <i>(e.g. Ronette SBK)</i><br>
      <b>Store Codes:</b><br>
      SBK = Springbok<br>
      PN = Port Nolloth<br>
      VRD = Vredendal
    </small>

    <label for="name">Your Name + Store Code:</label>
    <input type="text" id="name" name="name" required placeholder="e.g. Ronette SBK">

    <label for="mode">Scan Mode:</label>
    <select id="mode" name="mode" required onchange="adjustFormFields()">
      <option value="">Select Mode</option>
      <option value="Stocktake">Stocktake</option>
      <option value="OOS">Out of Stock</option>
      <option value="IDT">Inter Department Transfer (IDT)</option>
    </select>

    <div id="stocktakeFields" style="display:none">
      <label for="stockDate">Date of Stocktake:</label>
      <input type="date" id="stockDate">

      <label for="department">Department:</label>
      <select id="department"></select>
    </div>

    <div id="idtFields" style="display:none">
      <label for="fromDept">From Department:</label>
      <select id="fromDept"></select>

      <label for="toDept">To Department:</label>
      <select id="toDept"></select>
    </div>

    <div id="commonFields" style="display:none">
      <label for="barcode">Barcode:</label>
      <input type="text" id="barcode" name="barcode" required inputmode="numeric" pattern="[0-9]*">

      <div id="stocktakeExtra" style="display:none">
        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" min="0" step="any" inputmode="decimal" pattern="[0-9]+([.,][0-9]+)?">
      </div>

      <div id="idtExtra" style="display:none">
        <label for="idtQuantity">Quantity:</label>
        <input type="number" id="idtQuantity" min="0" step="any" inputmode="decimal" pattern="[0-9]+([.,][0-9]+)?">
      </div>
    </div>

    <button type="submit">Submit</button>
    <button type="button" class="btn-secondary" id="resetBtn">Reset</button>
  </form>

  <script>
    // ---------- Dropdown data ----------
    const departments = [
      "BAKERY CONFEC", "BUTCHERY", "DELICATESSEN", "FRUIT & VEG", "FAST FOODS",
      "BEAN TREE", "BULK CHEESE", "SUSHI", "WHY NOT", "CHIKKA CHICKEN", "BAKERY BREAD",
      "BAKERY CONFEC_INGREDIENTS", "BUTCHERY_INGREDIENTS", "DELICATESSEN_INGREDIENTS",
      "FRUIT & VEG_INGREDIENTS", "FAST FOODS_INGREDIENTS", "BEAN TREE_INGREDIENTS",
      "BULK CHEESE_INGREDIENTS", "SUSHI_INGREDIENTS", "WHY NOT_INGREDIENTS",
      "CHIKKA CHICKEN_INGREDIENTS", "BAKERY BREAD_INGREDIENTS"
    ];

    const fillDropdown = (id) => {
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">Select</option>';
      departments.forEach(dept => {
        const opt = document.createElement('option');
        opt.value = dept;
        opt.textContent = dept;
        select.add(opt);
      });
    };

    function adjustFormFields() {
      const mode = document.getElementById("mode").value;
      document.getElementById("stocktakeFields").style.display = (mode === 'Stocktake') ? 'block' : 'none';
      document.getElementById("idtFields").style.display = (mode === 'IDT') ? 'block' : 'none';
      document.getElementById("commonFields").style.display = mode ? 'block' : 'none';
      document.getElementById("stocktakeExtra").style.display = (mode === 'Stocktake') ? 'block' : 'none';
      document.getElementById("idtExtra").style.display = (mode === 'IDT') ? 'block' : 'none';
    }

    // ---------- Name lock & persistence ----------
    const NAME_KEY = "burfam_scanner_name";
    const nameEl = document.getElementById("name");
    function lockNameField(lock) {
      nameEl.readOnly = !!lock;
      nameEl.style.background = lock ? "#f3f3f3" : "";
    }

    (function initName() {
      const saved = localStorage.getItem(NAME_KEY);
      if (saved) {
        nameEl.value = saved;
        lockNameField(true);
      } else {
        lockNameField(false);
      }
    })();

    function ensureNameSaved() {
      const val = nameEl.value.trim();
      if (!val) return false;
      if (!localStorage.getItem(NAME_KEY)) {
        localStorage.setItem(NAME_KEY, val);
        lockNameField(true);
      }
      return true;
    }

    document.getElementById("resetBtn").addEventListener("click", function() {
      localStorage.removeItem(NAME_KEY);
      nameEl.value = "";
      lockNameField(false);
      document.getElementById("mode").value = "";
      adjustFormFields();
      ["barcode","quantity","idtQuantity"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      nameEl.focus();
    });

    // ---------- Force scan only into Barcode ----------
    document.addEventListener("keydown", (e) => {
      const isDigit = e.key >= "0" && e.key <= "9";
      if (!isDigit) return;
      const active = document.activeElement;
      if (active.id !== "barcode" && active.id !== "quantity" && active.id !== "idtQuantity") {
        e.preventDefault();
        alert("Please scan in the BARCODE field.");
        document.getElementById("barcode").focus();
      }
    }, true);

    nameEl.addEventListener("beforeinput", (e) => {
      if (nameEl.readOnly) e.preventDefault();
    });

    // ---------- Submit ----------
    document.getElementById("scannerForm").addEventListener("submit", function(e) {
      e.preventDefault();

      if (!ensureNameSaved()) {
        alert("Please enter your Name + Store Code (e.g. Ronette SBK)");
        nameEl.focus();
        return;
      }

      const mode = document.getElementById("mode").value;
      const timestamp = new Date().toISOString();
      const nameField = nameEl.value.trim();
      const barcode = document.getElementById("barcode").value.trim();

      const payload = {
        mode,
        timestamp,
        name: nameField,
        store: nameField.split(" ").pop(),
        barcode
      };

      if (mode === "Stocktake") {
        payload.department = document.getElementById("department").value;
        payload.stockDate = document.getElementById("stockDate").value;
        payload.quantity = document.getElementById("quantity").value;
      } else if (mode === "IDT") {
        payload.fromDept = document.getElementById("fromDept").value;
        payload.toDept = document.getElementById("toDept").value;
        payload.quantity = document.getElementById("idtQuantity").value;
      }

      fetch("https://script.google.com/macros/s/AKfycbzJLQD6WScnGAd8PlYtfcdhH6Km7Kt31E2b4d0md0kLRw8cryX0GbSil_1zwWlSpIS9hQ/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      alert("DONE - Check before submit");

      ["barcode","quantity","idtQuantity"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      document.getElementById("barcode").focus();
    });

    window.onload = function() {
      fillDropdown("department");
      fillDropdown("fromDept");
      fillDropdown("toDept");
      adjustFormFields();
    };
  </script>
</body>
</html>
